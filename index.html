<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Marxia â€” Orden RÃ¡pida</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #0e1324;
      color: #e8eef6;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .wrap { width: 100%; max-width: 800px; padding: 1rem; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    h1 { font-size: 1.5rem; }
    .controls { display: flex; gap: 0.5rem; }
    .toggle { padding: 0.5rem 1rem; border: 1px solid #2b2f40; background: #161a2b; color: #e8eef6; border-radius: 20px; cursor: pointer; }
    .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .layout { grid-template-columns: 1fr; } }
    .card { background: #161a2b; border: 1px solid #2b2f40; border-radius: 8px; padding: 1rem; }
    aside.card { display: flex; flex-direction: column; }
    .title { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.8rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem; }
    .opt { background: #1c2135; border: 1px solid #2b2f40; border-radius: 8px; padding: 0.8rem; }
    .top { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .btn50 { width: 30px; height: 30px; border: none; border-radius: 6px; font-weight: bold; color: #111; }
    .op1 { background: #7aa8ff; } .op2 { background: #22c3a6; } .op3 { background: #ff8ab3; } .op4 { background: #c466ff; }
    .desc { color: #a9b3c3; font-size: 0.9rem; }
    .actions { display: flex; gap: 0.5rem; }
    .btn { padding: 5px 10px; border: 1px solid #2b2f40; background: transparent; color: #e8eef6; border-radius: 8px; cursor: pointer; font-size: 12px; }
    .btn-adding { background: #22c3a6; color: #0b0f18; border-color: #22c3a6; }
    .ex-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .ex-row { display: grid; grid-template-columns: 1fr auto; align-items: center; background: #1c2135; border: 1px solid #2b2f40; border-radius: 8px; padding: 0.8rem; }
    .ex-price { font-size: 0.8rem; padding: 0.3rem 0.6rem; border: 1px dashed #2b2f40; border-radius: 6px; }
    .cart { border: 1px dashed #2b2f40; border-radius: 8px; padding: 0.8rem; max-height: 250px; overflow: auto; }
    .line { display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; padding: 0.5rem 0; border-bottom: 1px dotted #2b2f40; }
    .qtybox { display: flex; align-items: center; gap: 0.3rem; }
    .totals { margin-top: 0.8rem; display: grid; gap: 0.3rem; }
    .totals .row { display: flex; justify-content: space-between; }
    .grand { font-size: 1.3rem; font-weight: bold; }
    .accept-btn { margin-top: 1rem; padding: 0.8rem 1.5rem; font-size: 1rem; background: #22c3a6; color: #0b0f18; border: none; border-radius: 8px; cursor: pointer; align-self: flex-end; }
    .accept-btn:hover { background: #1aa58a; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #22c3a6; color: #0b0f18; padding: 0.6rem 1rem; border-radius: 8px; font-weight: bold; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #22c3a6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    [data-theme="light"] body { background: #f3f6f9; }
    [data-theme="light"] .card, [data-theme="light"] .opt, [data-theme="light"] .ex-row, [data-theme="light"] .cart { background: #ffffff; border-color: #d1d9e6; }
    [data-theme="light"] .line { border-color: #d1d9e6; }
    [data-theme="light"] .btn-adding { background: #22c3a6; color: #0b0f18; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Orden RÃ¡pida</h1>
      <div class="controls">
        <button id="lang" class="toggle">ES</button>
        <button id="theme" class="toggle">ðŸŒ™</button>
      </div>
    </header>
    <div class="layout">
      <section class="card">
        <h2 class="title">Opciones</h2>
        <div id="opts" class="grid"></div>
        <div class="card" style="margin-top: 10px;">
          <h2 class="title">Extras</h2>
          <div id="extras" class="ex-list"></div>
        </div>
      </section>
      <aside class="card">
        <h2 class="title">Resumen</h2>
        <div id="cart" class="cart"></div>
        <div class="totals">
          <div class="row"><div>Subtotal</div><div id="subtotal">â€”</div></div>
          <div class="row"><div>IVA (15%)</div><div id="vat">â€”</div></div>
          <div class="row"><div class="grand">TOTAL</div><div id="total" class="grand">â€”</div></div>
        </div>
        <button id="accept" class="accept-btn">Aceptar</button>
      </aside>
    </div>
  </div>
  <div id="loader" class="loader-overlay"><div class="loader"></div></div>
  <div id="toast" class="toast">Â¡Pedido enviado con Ã©xito!</div>

  <script>
    const IVA_RATE = 0.15;
    const LOCALE = { es: 'es-EC', en: 'en-US' };
    let currentLang = 'es';
    const OPTIONS = [
      { id: 'op1', name: { es: 'OpciÃ³n 1', en: 'Option 1' }, desc: { es: 'Tortilla + Huevos + Chorizo + Bebida', en: 'Tortilla + Eggs + Sausage + Drink' }, priceCents: 320 },
      { id: 'op2', name: { es: 'OpciÃ³n 2', en: 'Option 2' }, desc: { es: 'Tortilla + Chorizo + Bebida', en: 'Tortilla + Sausage + Drink' }, priceCents: 270 },
      { id: 'op3', name: { es: 'OpciÃ³n 3', en: 'Option 3' }, desc: { es: 'Tortilla + Huevos + Bebida', en: 'Tortilla + Eggs + Drink' }, priceCents: 270 },
      { id: 'op4', name: { es: 'OpciÃ³n 4', en: 'Option 4' }, desc: { es: '2 Tortilla + 2 Huevos + 2 Chorizo + 2 Bebida', en: '2 Tortillas + 2 Eggs + 2 Sausages + 2 Drinks' }, priceCents: 640 }
    ];
    const EXTRAS = [
      { id: 'ex_cafe', name: { es: 'CafÃ©', en: 'Coffee' }, priceCents: 70 },
      { id: 'ex_cola', name: { es: 'Cola', en: 'Cola' }, priceCents: 70 },
      { id: 'ex_chorizo', name: { es: 'Chorizo', en: 'Sausage' }, priceCents: 70 },
      { id: 'ex_huevo', name: { es: 'Huevo', en: 'Egg' }, priceCents: 70 },
      { id: 'ex_tortilla', name: { es: 'Tortilla', en: 'Tortilla' }, priceCents: 70 }
    ];
    const cart = new Map();
    const $ = s => document.querySelector(s);
    const t = v => typeof v === 'string' ? v : v[currentLang];
    const money = c => (c/100).toLocaleString(LOCALE[currentLang], { style: 'currency', currency: 'USD' });

    function add(item) {
      const line = cart.get(item.id) || { ...item, qty: 0 };
      line.qty++;
      cart.set(item.id, line);
      const btn = $(`button[data-act="add"][data-id="${item.id}"]`);
      if (btn && document.documentElement.getAttribute('data-theme') === 'dark') {
        btn.classList.add('btn-adding');
        setTimeout(() => btn.classList.remove('btn-adding'), 1500);
      }
      render();
    }

    function rem(item) {
      if (!cart.has(item.id)) return;
      const line = cart.get(item.id);
      line.qty--;
      if (line.qty <= 0) cart.delete(item.id);
      else cart.set(item.id, line);
      render();
    }

    function buildOptions() {
      const host = $('#opts');
      host.innerHTML = '';
      OPTIONS.forEach((o, i) => {
        const el = document.createElement('div');
        el.className = 'opt';
        el.innerHTML = `
          <div class="top">
            <button class="btn50 op${(i%4)+1}">${i+1}</button>
            <div>
              <div class="desc">${t(o.desc)} â€” <strong>${money(o.priceCents)}</strong></div>
              <div class="actions">
                <button class="btn" data-act="rem" data-id="${o.id}">âˆ’ Quitar</button>
                <button class="btn" data-act="add" data-id="${o.id}">+ Agregar</button>
              </div>
            </div>
          </div>`;
        host.appendChild(el);
      });
    }

    function buildExtras() {
      const host = $('#extras');
      host.innerHTML = '';
      EXTRAS.forEach(e => {
        const row = document.createElement('div');
        row.className = 'ex-row';
        row.innerHTML = `
          <div class="ex-left">${t(e.name)} <span class="ex-price">${money(e.priceCents)}</span></div>
          <div class="actions">
            <button class="btn" data-act="rem" data-id="${e.id}">âˆ’</button>
            <button class="btn" data-act="add" data-id="${e.id}">+ Agregar</button>
          </div>`;
        host.appendChild(row);
      });
    }

    function render() {
      const box = $('#cart');
      box.innerHTML = '';
      let subtotal = 0;
      cart.forEach(line => {
        subtotal += line.priceCents * line.qty;
        const el = document.createElement('div');
        el.className = 'line';
        el.innerHTML = `
          <div>${t(line.name)}</div>
          <div class="qtybox">
            <button class="btn" data-act="rem" data-id="${line.id}">âˆ’</button>
            <span>${line.qty}</span>
            <button class="btn" data-act="add" data-id="${line.id}">+</button>
          </div>
          <div><strong>${money(line.priceCents * line.qty)}</strong></div>`;
        box.appendChild(el);
      });
      const vat = Math.round(subtotal * IVA_RATE);
      const total = subtotal + vat;
      $('#subtotal').textContent = money(subtotal);
      $('#vat').textContent = money(vat);
      $('#total').textContent = money(total);
    }

    $('#lang').addEventListener('click', () => {
      currentLang = currentLang === 'es' ? 'en' : 'es';
      $('#lang').textContent = currentLang.toUpperCase();
      buildOptions();
      buildExtras();
      render();
    });

    $('#theme').addEventListener('click', () => {
      const root = document.documentElement;
      const cur = root.getAttribute('data-theme') || 'dark';
      const next = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      $('#theme').textContent = next === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
    });

    document.body.addEventListener('click', e => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const item = OPTIONS.find(x => x.id === id) || EXTRAS.find(x => x.id === id) || cart.get(id);
      if (!item) return;
      const payload = { id: item.id, name: t(item.name), priceCents: item.priceCents };
      act === 'add' ? add(payload) : rem(payload);
    });

    $('#accept').addEventListener('click', () => {
      if (cart.size === 0) {
        showToast('Carrito vacÃ­o');
        return;
      }
      const rows = [];
      cart.forEach(item => {
        const rowSubtotal = item.qty * item.priceCents;
        const rowVAT = Math.round(rowSubtotal * IVA_RATE);
        const rowTotal = rowSubtotal + rowVAT;
        rows.push({
          timestamp: new Date().toISOString(),
          item: t(item.name),
          qty: item.qty,
          subtotal: (rowSubtotal / 100).toFixed(2),
          vat: (rowVAT / 100).toFixed(2),
          total: (rowTotal / 100).toFixed(2)
        });
      });
      $('#loader').style.display = 'flex';
      google.script.run
        .withSuccessHandler(res => {
          $('#loader').style.display = 'none';
          showToast(res.message);
          if (res.success) {
            cart.clear();
            render();
          }
        })
        .withFailureHandler(() => {
          $('#loader').style.display = 'none';
          showToast('No se pudo conectar al servidor.');
        })
        .saveOrder(rows);
    });

    function showToast(msg, ms = 1500) {
      const toast = $('#toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), ms);
    }

    (function init() {
      document.documentElement.setAttribute('data-theme', 'dark');
      buildOptions();
      buildExtras();
      render();
    })();
  </script>
</body>
</html>
